stages:
  - test
  - build
  - deploy

.golang_common: &golang_common
  image: golang:1.16
  variables:
    GOOS: linux
    GOARCH: amd64
  before_script:
    - env GOOS=linux GOARCH=amd64

test PrinterScript:
  <<: *golang_common
  stage: test
  script:
    - cd printerscript
    - GO111MODULE=off go get github.com/antlr/antlr4/runtime/Go/antlr
    - GO111MODULE=off go test

test MSF:
  <<: *golang_common
  stage: test
  script:
    - cd msf
    - GO111MODULE=off go get github.com/antlr/antlr4/runtime/Go/antlr
    - GO111MODULE=off go test

build:
  <<: *golang_common
  stage: build
  artifacts:
    paths:
      - ps-postprocess
    expire_in: 1 day
  script:
    - GO111MODULE=off go get github.com/antlr/antlr4/runtime/Go/antlr
    - GO111MODULE=off go build

deploy dev:
  image: napp/docker-aws-cli
  stage: deploy
  dependencies:
    - build
  only:
    - master
  environment:
    name: development
  script:
    - aws s3 cp ./ps-postprocess s3://$AWS_BUCKET/go-utils/ps-postprocess-development

deploy prod:
  image: napp/docker-aws-cli
  stage: deploy
  dependencies:
    - build
  only:
    - production
  environment:
    name: production
  script:
    - aws s3 cp ./ps-postprocess s3://$AWS_BUCKET/go-utils/ps-postprocess-production
